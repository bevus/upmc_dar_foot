
<section class="content">
    <div class="container">
        <div class="row">
            <!--details match-->
            <div class="col-md-6">
                <h3>Détails de la rencontre</h3>
                <hr>
                <div class="row">
                    <div class="col-md-2">
                        <img id="imgOrganiser" src="" class="img-circle img-thumbnail" width="80" height="80">
                    </div>
                    <div class="col-md-10">
                        <h4 id="fullNameOrganizer"></h4>
                        <p id="matchDescription"></p>
                        <p><b id="matchDate"></b> <b id="stadiumCity"></b></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h3 id="playersNumber" class=""></h3>
                    </div>
                </div>
                <h3>Composition des equipes</h3>
                <hr>
                <div id="composition">

                </div>
            </div>
            <!--details stade-->
            <div class="col-md-6">
                <h3>Stade</h3>
                <hr>
                <h3 class="text-capitalize" id="stadiumName"></h3>
                <h4 class="note"></h4>
                <div class="row">
                    <div class="col-md-12">
                        <h3 id="note" class="pull-right"></h3>
                        <div id="stadiumLocation" style="height: 300px; width: 100%">
                        </div>
                    </div>
                    <div id="days" class="col-md-12">

                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <form class="form-horizontal" id="commentForm">
                    <fieldset>
                        <!-- Form Name -->
                        <h4 class="text-info">donnez votre avis sur ce stade pour aider les autre utilisateur à avoir des information sur ce stade</h4>
                        <!-- Textarea -->
                        <input type="hidden" name="idStade" id="idStade">
                        <div class="form-group">
                            <div class="col-md-12">
                                <textarea class="form-control" id="textComment" rows="5" name="textComment"></textarea>
                                <span class="help-block alert-danger"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-12">
                                <a id="submitComment" href="" class="btn btn-primary pull-right">envoyer</a>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <br>
            <div id="comments">
            </div>
            <div class="col-md-12 text-center">
                <a href="" id="showComments">Afficher les commentaires sur ce stade</a>
            </div>
        </div>
    </div>
</section>
<script>
    var map;
    var rencontre = null;
    var stade = null;
    var params = window.location.href.split('?');
    var id;
    var connectedPlayer = "connectedPlayer";

    $(function(){
        // mettre à jour la page
        if(params.length > 1){
            var tmp = params[1].split('=');
            if(tmp.length == 2){
                id = tmp[1];
            }
        }
        if(id && id.length){
            $.get(
                    "/detailRencontre",
                    {
                        id : id
                    },
                    updateViewRencontre,
                    'json'
            );
            // ajour d'un nouveau commentaire sur un stade
            $("#submitComment").click(function (e) {
                e.preventDefault();
                if($("#textComment").val()){
                    $.post(
                            '/stadeCommentSubmit',
                            $("#commentForm").serialize(),
                            handleSubmitComment,
                            "json"
                    );
                }
            });
            // choisir une equipe
            $("body").on('click', '.team', function (e) {
                e.preventDefault();
                if(!$(this).hasClass("closed")){
                    var params = {
                        team : $(this).attr("data-team"),
                        rencontreId : $(this).attr("data-id")
                    };
                    $.post(
                            '/detailRencontre',
                            params,
                            joinGame,
                            'json'
                    );
                }
            });
            $("body").on('click', '.cancelReservation', function (e) {
                e.preventDefault();
                if(user != null){
                    var index = -1;
                    for(var i = 0; i < rencontre.players.length; i++){
                        if(rencontre.players[i].player.id == user.id){
                            index = i;
                            break;
                        }
                    }
                    if(index != -1){
                        $.post('/cancelParticipation', {
                            rencontreId : $(this).attr("data-id")
                        }, function(data) {
                            if(!data.error){
                                rencontre.players.splice(index, 1);
                                listPlayers(rencontre.players, $('#teamA').empty(), $('#teamB').empty(), user, connectedPlayer);
                                $("#joinButtons").slideUp(200).html(
                                        `<div class="col-md-12">
                                    <hr/>
                                </div>`).append(joinGameButtons(rencontre)).slideDown(200);
                            }else{
                                showModal("", data.error);
                            }
                        }, 'json');
                    }
                }
            });

            // upvote comment
            $("body").on("click", ".voteComment", function (e) {
                e.preventDefault();
                var element = $(this);
                if(user != undefined){
                    $.post('/upvoteComment', {commentId : element.attr("data-id")}, function (data) {
                        if(data.ok){
                            element.hide();
                        }
                    }, 'json');
                }else{
                    showModal("", "vous devez vous connecter pour pouvoir effectuer cette action")
                }
            }).on("click", ".voteStade", function (e) {
                // upvote stade
                e.preventDefault();
                var element = $(this);
                if(user != undefined){
                    $.post('/upvoteStadium', {stadeId : element.attr("data-id")}, function (data) {
                        if(data.ok){
                            element.hide();
                        }
                    }, 'json');
                }else{
                    showModal("", "vous devez vous connecter pour pouvoir effectuer cette action")
                }
            })
        }else{
            $(".content").html("");
            showModal('', '<p class="alert alert-danger">aucune rencontre séléctionée</p>')
        }
        $('#showComments').click(function (e) {
            e.preventDefault();
            if(stade != null) {
                var commentsCount = $(".comment").length;
                getComments(stade.id, commentsCount, 5, $('#comments'), "comment", user, function () {
                    $('#showComments').text("afficher plus de commentaires");
                    if(commentsCount == $(".comment").length){
                        $('#showComments').hide();
                    }
                });
            }
        });
    });
    /**
     * utilisée dans : rencontre.html
     * met à jour la page rencontre
     * @param data
     */
    function updateViewRencontre(data) {
        if(!data.error){
            rencontre = data;
            $("#imgOrganiser").attr("src", "Ressources/images/"+rencontre.organizer.img);
            $("#fullNameOrganizer").text(rencontre.organizer.firstName + ' ' + rencontre.organizer.lastName);
            $("#matchDescription").text(rencontre.description);
            $("#matchDate").text(getDate(rencontre.dateDebut));
            $("#playersNumber").text(rencontre.players.length + "/" + (rencontre.nbJoueurs * 2)).addClass((rencontre.players.length < (rencontre.nbJoueurs * 2  ))? "text-success" : "text-danger");
            $("#stadiumCity").text(rencontre.stade.commune);
            teamsComposition(rencontre, $("#composition"), user);
            stade = rencontre.stade;
            $("#stadiumName").text(stade.nom + ' ' + stade.commune + ' ' + stade.codePostal);
            if(user != undefined){
                var voted = false;
                $.each(stade.stadeUpvoters, function (i, v) {
                    if(v.id == user.id){
                        voted = true;
                    }
                });
                if(!voted){
                    $("#note").html('<a href=""><i data-id="'+ stade.id +'" class="voteStade glyphicon glyphicon-thumbs-up"></i></a>');
                }
            }
            $("#idStade").val(stade.id);
            loadLocalWeather(id, 6, $("#days"));
            $("body").append('<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDyw6uBdlxvjGFSCXauLkcoPdwIwaJehSE&callback=initMap"/>');
        }else{
//            window.location.replace("/404.html");
        }
    }
    /**
     * utilisée dans : rencontre.html
     * s'occupe de soumettre le formulaire de commentaire et de mettre à jour la liste des commentaires
     * @param data
     */
    function handleSubmitComment(data) {
        if(data.error){
            var errorString;
            $.each(data.error, function (key, val) {
                errorString += val + "\n";
            })
        }else{
            $('#comments').prepend(addComment(data));
            $("#textComment").val("");
        }
    }
    /**
     * utilisée dans : rencontre.html
     * initialise la carte google map (method applée en jsonp)
     */
    function initMap() {
        var coords = {lat: stade.latitude, lng: stade.longitude};
        map = new google.maps.Map(document.getElementById("stadiumLocation"), {
            center: coords,
            zoom: 18,
            mapTypeId: google.maps.MapTypeId.SATELLITE
        });
        var marker = new google.maps.Marker({
            position: coords,
            map: map,
            title: stade.nom
        });
    }
    /**
     * utilisée dans : rencontre.html
     * getion des equipe (callback recquete ajax choix equipe)
     */
    function joinGame(data) {
        if(data.error){
            modalBody = "<p class='alert alert-danger'>";
            $.each(data, function (key, value) {
                if(key != "error"){
                    modalBody += value + "<br/>";
                }
            });
            modalBody += "</p>";
            showModal("", modalBody);
        }else{
            rencontre.players.push(data);
            var team;
            console.log(data.team);
            if (data.team == "A") {
                team = $("#teamA");
            } else if (data.team == "B") {
                team = $("#teamB");
            }
            team.append(addPlayer(data, connectedPlayer));
            $('.'+connectedPlayer).hide().slideDown(400);
            $("#joinButtons").slideUp(200).html(
                    `<div class="col-md-12">
                          <hr/>
                    </div>`).append(cancelButton(data.team, rencontre, user)).slideDown(200);
        }
    }
    function addPlayer(player, cls) {
        return `<p class="${cls}">${player.player.firstName} ${player.player.lastName}</p>`;
    }
    function cancelButton(userTeam, rencontre, user) {
        if(user != null && user.id == rencontre.organizer.id){
            return "";
        }
        switch (userTeam) {
            case "A":
                return `<div class="col-md-6 text-center">
                                    <a class="cancelReservation btn btn-warning" href="" data-id="${rencontre.id}">Je ne serai pas présent</a>
                                </div>`
                ;
            case "B":
                return `<div class="col-md-6 col-md-offset-6 text-center">
                                    <a class="cancelReservation btn btn-warning" href="" data-id="${rencontre.id}">Je ne serai pas présent</a>
                                </div>`
                ;
        }
        return "";
    }
    function joinGameButtons(rencontre) {
        var countTeamA = 0;
        var countTeamB = 0;
        $.each(rencontre.players, function (i, v) {
            if(v.team == "A")
                countTeamA++;
            if(v.team == "B")
                countTeamB++;
        });
        var buttonA = "";
        var buttonB = "";
        if (countTeamA < rencontre.nbJoueurs) {
            buttonA =
                    `<div class="col-md-6 text-center">
                                     <a class="team btn btn-success" href="" data-team="${'A'}" data-id="${rencontre.id}">Jouer en équipe A</a>
                                </div>`
            ;
        } else {
            buttonA = `<div class="col-md-6 text-center"></div>`;
        }
        if (countTeamB < rencontre.nbJoueurs) {
            buttonB =
                    `<div class="col-md-6 text-center">
                                 <a class="team btn btn-success" href="" data-team="${'B'}" data-id="${rencontre.id}">Jouer en équipe B</a>
                            </div>`
            ;
        } else {
            buttonB = `<div class="col-md-6 text-center"></div>`;
        }
        return buttonA + buttonB;
    }
    function loginButton() {
        return `<div class="col-md-12  text-center">
                        <a href="" data-toggle="modal" data-target="#loginModal">Connectez vous pour pouvoir participer à ce match</a>
                </div>`;
    }
    function listPlayers(players, teamAElement, teamBelement, user, userClass) {
        var userTeam = undefined;
        $.each(players, function (i, player) {
            var team;
            var cls;
            if(player.team == "A"){
                team = teamAElement;
                if(user != null && player.player.id == user.id){
                    cls = connectedPlayer;
                    userTeam = "A";
                }
            }else if(player.team == "B"){
                team = teamBelement;
                if(user != null && player.player.id == user.id){
                    cls = userClass;
                    userTeam = "B";
                }
            }
            team.append(addPlayer(player, cls));
        });
        return userTeam;
    }

    function teamsComposition(rencontre, element, user) {
        element.append(
                `<div class="row">
                        <div class="col-md-6 text-center" id="teamA">
                        </div>
                        <div class="col-md-6 text-center" id="teamB">
                        </div>
                        <div class="row" id="joinButtons">
                        <div class="col-md-12">
                            <hr/>
                        </div>
                        </div>
                        <div class="col-md-12">
                            <hr/>
                        </div>
                </div>`
        );
        var userTeam = listPlayers(rencontre.players, $("#teamA"), $("#teamB"), user, connectedPlayer );

        if(user != null){
            if(userTeam != undefined){
                $("#joinButtons").append(cancelButton(userTeam, rencontre, user));
            }else{
                $("#joinButtons").append(joinGameButtons(rencontre));
            }
        }else{
            var countTeamA = rencontre.players.filter(p => p.team == 'A').length;
            var countTeamB = rencontre.players.filter(p => p.team == 'B').length;
            if(countTeamA < rencontre.nbJoueurs || countTeamB < rencontre.nbJoueurs){
                $("#joinButtons").append(loginButton());
            }
        }
    }
</script>
