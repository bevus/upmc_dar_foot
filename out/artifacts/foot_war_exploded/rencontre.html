
<section class="content">
    <div class="container">
        <div class="row">
            <div class="col-md-6 blackCard">
                <h3>Détails de la rencontre</h3>
                <hr>
                <div class="row">
                    <div class="col-md-2">
                        <img id="imgOrganiser" src="" class="img-circle img-thumbnail" width="80" height="80">
                    </div>
                    <div class="col-md-10">
                        <h4 id="fullNameOrganizer"></h4>
                        <p id="matchDescription"></p>
                        <p><b id="matchDate"></b> <b id="stadiumCity"></b></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12" style="text-align: right">
                        <h3 id="playersNumber" class=""></h3>
                    </div>
                </div>
                <h3>Composition des equipes</h3>
                <hr>
                <div class="row text-center">
                    <div class="col-md-5">
                        <a id="teamABtn" data-id="" data-team="A" href="" class="team btn btn-sm "></a>
                        <hr>
                        <div id="playersA">

                        </div>
                    </div>
                    <div class="col-md-5 col-md-offset-2">
                        <a id="teamBBtn" data-id="" data-team="B" href="" class="team btn btn-sm "></a>
                        <hr>
                        <div id="playersB">

                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-5 col-md-offset-1 blackCard">
                <h3 id="cityName">Chargement des données météo</h3>
                <hr>
                <div id="days" class="row">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 blackCard">
                <h3>Stade</h3>
                <hr>
                <h3 class="text-capitalize" id="stadiumName"></h3>
                <h4 class="note">4.5/5</h4>
                <div class="row">
                    <div class="col-md-5">
                        <div id="stadiumLocation" style="height: 300px; width: 100%">
                        </div>
                    </div>
                    <div class="col-md-5 col-lg-offset-2">

                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h3>Avis</h3>
                        <hr>
                        <form class="form-horizontal" id="commentForm">
                            <fieldset>
                                <!-- Form Name -->
                                <legend>donnez votre avis sur ce stade pour aider les autre utilisateur à avoir des information sur ce stade</legend>
                                <!-- Textarea -->
                                <input type="hidden" name="idStade" id="idStade">
                                <div class="form-group">
                                    <div class="col-md-12">
                                        <textarea class="form-control" id="textComment" rows="5" name="textComment"></textarea>
                                        <span class="help-block alert-danger"></span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-md-12">
                                        <a id="submitComment" href="" class="btn btn-primary pull-right">envoyer</a>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                    <br>
                    <div id="comments">
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    var map;
    var rencontre = null;
    var stade = null;
    var params = window.location.href.split('?');
    var id;
    $(function(){
        // mettre à jour la page
        if(params.length > 1){
            var tmp = params[1].split('=');
            if(tmp.length == 2){
                id = tmp[1];
            }
        }
        if(id && id.length){
            $.get(
                    "/detailRencontre",
                    {
                        id : id
                    },
                    updateViewRencontre,
                    'json'
            );
            // ajour d'un nouveau commentaire sur un stade
            $("#submitComment").click(function (e) {
                e.preventDefault();
                if($("#textComment").val()){
                    $.post(
                            '/stadeCommentSubmit',
                            $("#commentForm").serialize(),
                            handleSubmitComment,
                            "json"
                    );
                }
            });
            // choisir une equipe
            $(".team").click(function (e) {
                e.preventDefault();
                if(!$(this).hasClass("closed")){
                    var params = {
                        team : $(this).attr("data-team"),
                        rencontreId : $(this).attr("data-id")
                    };
                    $.post(
                            '/detailRencontre',
                            params,
                            joinGame,
                            'json'
                    );
                }
            });
        }else{
            $(".content").html("");
            showModal('', '<p class="alert alert-danger">aucune rencontre séléctionée</p>')
        }
    });
    // todo gestion des equipes
    // todo controle des equipes (ne pas participer deux fois dans la meme equipe)
    // todo image stade !
    // todo gestion des session pour savoir quelle rencontre afficher
    /**
     * utilisée dans : rencontre.html
     * met à jour la page rencontre
     * @param data
     */
    function updateViewRencontre(data) {
        if(!data.error){
            rencontre = data;
            $("#imgOrganiser").attr("src", "Ressources/images/"+rencontre.organizer.img);
            $("#fullNameOrganizer").text(rencontre.organizer.firstName + ' ' + rencontre.organizer.lastName);
            $("#matchDescription").text(rencontre.description);
            $("#matchDate").text(getDate(rencontre.dateDebut));
            $("#playersNumber").text(rencontre.players.length + "/" + (rencontre.nbJoueurs * 2)).addClass((rencontre.players.length < (rencontre.nbJoueurs * 2  ))? "text-success" : "text-danger");
            $("#stadiumCity").text(rencontre.stade.commune);
            $(".team").attr("data-id", rencontre.id);
            var players = rencontre.players;
            var teamACount = 0;
            var teamBCount = 0;
            $.each(players, function (i, player) {
                var team;
                if(player.team == "A"){
                    teamACount++;
                    team = $("#playersA");
                }else if(player.team == "B"){
                    teamBCount++;
                    team = $("#playersB");
                }
                team.append(addPlayer(player));
            });
            if(teamACount < rencontre.nbJoueurs){
                $("#teamABtn").text("jouer en équipe A").addClass("btn-primary");
            }else{
                $("#teamABtn").text("équipe A complète").addClass("btn-warning disabled closed");
            }
            if(teamBCount < rencontre.nbJoueurs){
                $("#teamBBtn").text("jouer en équipe B").addClass("btn-success");
            }else{
                $("#teamBBtn").text("équipe B complète").addClass("btn-warning disabled closed");
            }

            stade = rencontre.stade;
            $("#stadiumName").text(stade.nom + ' ' + stade.commune + ' ' + stade.codePostal);
            $.each(rencontre.stade.comments, function (i, comment) {
                $('#comments').append(addComment(comment));
            });
            $("#idStade").val(stade.id);
            loadWeatherData(stade.latitude, stade.longitude, 16, $("#days"));
            $("body").append('<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDyw6uBdlxvjGFSCXauLkcoPdwIwaJehSE&callback=initMap"/>');
        }else{
            showModal("", '<p class="alert alert-danger">' + data.error + '</p>')
        }
    }
    /**
     * utilisée dans : rencontre.html
     * s'occupe de soumettre le formulaire de commentaire et de mettre à jour la liste des commentaires
     * @param data
     */
    function handleSubmitComment(data) {
        if(data.error){
            var errorString;
            $.each(data.error, function (key, val) {
                errorString += val + "\n";
            })
        }else{
            $('#comments').prepend(addComment(data));
            $("#textComment").val("");
        }
    }
    /**
     * utilisée dans : rencontre.html
     * initialise la carte google map (method applée en jsonp)
     */
    function initMap() {
        var coords = {lat: stade.latitude, lng: stade.longitude};
        map = new google.maps.Map(document.getElementById("stadiumLocation"), {
            center: coords,
            zoom: 18,
            mapTypeId: google.maps.MapTypeId.SATELLITE
        });
        var marker = new google.maps.Marker({
            position: coords,
            map: map,
            title: stade.nom
        });
    }
    /**
     * utilisée dans : rencontre.html
     * format la date (Le d/m/yy à h:m)
     * @param timestamp
     * @returns {string}
     */
    function getDate(timestamp) {
        var date = new Date(timestamp);
        return "Le "+date.getDate()+"/"+(date.getMonth() + 1)+"/"+date.getFullYear()+" à "+date.getHours()+":"+date.getMinutes()
    }
    /**
     * utilisée dans : rencontre.html
     * retourn le code html d'un commentaire
     * @param comment
     * @returns {string}
     */
    function addComment(comment) {
        return '<div class="col-md-12 comment"> ' +
                '<div class = "col-md-1 text-center"> ' +
                '<img src = "/Ressources/images/' + comment.author.img + '" class="img-circle img-thumbnail" alt="">' +
                '</div>' +
                '<div class = "col-md-11">' +
                '<div class = "row">' +
                '<div class = "col-md-12">' +
                '<b class="pull-right">' + getDate(comment.dateComment) + '</b>' +
                '<h4>' + comment.author.firstName + ' ' + comment.author.lastName + '</h4>' +
                '</div > ' +
                '</div>' +
                '<div class="row">' +
                '<div class="col-md-12">' +
                '<p>' + comment.textComment + '</p>' +
                '<hr >' +
                '</div>' +
                '</div>' +
                '</div>';
    }
    /**
     * utilisée dans : rencontre.html
     * getion des equipe (callback recquete ajax choix equipe)
     */
    function joinGame(data) {
        if(data.error){
            modalBody = "<p class='alert alert-danger'>";
            $.each(data, function (key, value) {
                if(key != "error"){
                    modalBody += value + "<br/>";
                }
            });
            modalBody += "</p>";
            showModal("", modalBody);
        }else{
            var team;
            console.log(data.team);
            if (data.team == "A") {
                team = $("#playersA");
            } else if (data.team == "B") {
                team = $("#playersB");
            }
            team.append(addPlayer(data, "newPlayer"));
            $("newPlayer").hide().slideDown(400);
            $(".team").slideUp(200);
        }
    }
    /**
     * utilisée dans : rencontre.html
     * charge les données météos depuis le serveur qui contact l'api openweather
     * @param lat
     * @param lon
     * @param nbDays
     * @param element
     */
    function loadWeatherData(lat, lon, nbDays, element) {
        $.get(
                "/weather",
                {
                    lat : lat,
                    lon : lon,
                    nbDays : nbDays
                },
                function(data){
                    if(!data.error){
                        $.each(data.days, function(i, day){
                            element.append('' +
                                    '<div class="dayWeather">' +
                                    '<p>' + day.name + '</p>' +
                                    ' <img src="' + day.icon + '" alt="' + day.description + '"> ' +
                                    '<p><b>' + day.dayT + '°</b></p>' +
                                    '<p> ' + day.nightT + '°</p>' +
                                    '</div>');
                        });
                        $("#cityName").text("Prévision météo à " + data.city.name);
                    }else{
                        $("#days").append(
                                '<div class="col-md-4">' +
                                '<p class="alert alert-danger">impossible de charger les données météo</p> ' +
                                '</div>'
                        );
                    }
                },
                'json'
        )
    }
    function addPlayer(player, cls) {
        return "<p class='" + cls + "'>" + player.player.firstName + " " + player.player.lastName + "</p>";
    }
    /**
     * ajoute une modal a la page et l'afficher
     * @param title
     * @param body
     */
    function showModal(title, body) {
        if(!document.getElementById("messageModal")){
            $("body").append('<div class="modal fade" id="messageModal"><div class="modal-dialog"><div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button> <h4 class="modal-title"></h4> </div> <div class="modal-body"> </div> <div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">fermer</button></div></div></div></div>');
        }
        $("#messageModal").find(".modal-title").html("").append(title);
        $("#messageModal").find(".modal-body").html("").append(body);
        $('#messageModal').modal('show');
    }
</script>