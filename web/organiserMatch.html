<div class="container">
    <div class="blackCard">
        <div class="row">
            <form class="form-horizontal" id="schedulGameForm" action="/organise" method="post">
                <fieldset>
                    <legend>
                        Sélectionez un stade ou aura lieux la rencontre
                    </legend>
                    <div class="row">
                        <div class="col-md-10 col-md-offset-1 thumbnail">
                            <div id="map" style="height: 600px; width: 100%;">
                            </div>
                        </div>
                    </div>
                    <br/>
                    <div class="row">
                        <div class="col-md-offset-1 col-md-10 text-center">
                            <p id="stadeInfo" class="alert alert-danger">Aucun stade choisi, utilisez la carte ci-dessu pour séléctioner un stade</p>
                        </div>
                    </div>
                    <input type="hidden" id="stadeId" name="stadeId">
                </fieldset>
                <fieldset>
                    <legend id="matchDetails">Détail du match</legend>
                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="nbJoueurs">Nombre de joueurs par equipe</label>
                        <div class="col-md-4">
                            <input id="nbJoueurs" name="nbJoueurs" type="text" placeholder="ex 5, 11" class="form-control input-md" required="">
                            <span class="help-block alert-danger"></span>
                        </div>
                    </div>

                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="gameDate">Date et heure du match</label>
                        <div class="col-md-4">
                            <input id="gameDate" name="gameDate" type='text' class="form-control" />
                            <span class="help-block alert-danger"></span>
                        </div>
                    </div>

                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="description">Information sur le match</label>
                        <div class="col-md-4">
                            <textarea id="description" name="description" placeholder="Phrase pour decrire la rencontre" class="form-control input-md" required="" ></textarea>
                            <span class="help-block alert-danger"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-4 control-label" for="submit"></label>
                        <div class="col-md-4">
                            <button id="submit" name="submit" class="btn btn-primary">Organiser</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
</div>
<script src="Ressources/js/bower_components/moment/moment.js"></script>
<script src="Ressources/js/bower_components/moment/locale/fr.js"></script>
<script src="Ressources/js/bower_components/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDyw6uBdlxvjGFSCXauLkcoPdwIwaJehSE&callback=initMap">
</script>-->
<script src="Ressources/js/markerclusterer.js"></script>
<script>
    var map;
    var markers = [];
    $(function () {
        $('#gameDate').datetimepicker({
            locale: 'fr'
        });
    });
    function initMap() {
        var ileDeFrance = {lat: 48.8583905296204, lng: 2.3490142822265625};
        map = new google.maps.Map(document.getElementById('map'), {
            center  : ileDeFrance,
            zoom : 8
        });
        $("#map").on("click", ".selectStade", function (e) {
            e.preventDefault();
            $("#stadeId").val($(this).attr("data-stadeid"));
            $("#stadeInfo").removeClass("alert-danger").addClass("alert-success").text($(this).prev().text());
            $('html, body').animate({
                scrollTop: $("#matchDetails").offset().top
            }, 500);
            $("#nbJoueurs").focus();
        });
        $('#schedulGameForm').submit(function (e) {
            e.preventDefault();
            var params = {
                stadeId : $("#stadeId").val(),
                nbJoueurs : $("#nbJoueurs").val(),
                description : $("#description").val(),
                gameDate : $('#gameDate').data("DateTimePicker").date().valueOf()
            };
            $.post("/organise", params, function (data) {
                if(data.ok){
                    window.location.href = "/rencontre.html?id=" + data.id;
                }else{
                    $.each(data.error, function(i, v){
                        $('#'+i).parent().find(".help-block").text(v);
                    });
                }
            }, 'json');
        });
        $.get(
                '/stades',{},function (data) {
                    if(data){
                        var infoWindow = new google.maps.InfoWindow({
                            content : ""
                        });
                        $.each(data, function (i, stade) {
                            var marker = new google.maps.Marker({
                                position : {lat: stade.lat, lng: stade.lon},
                                title : stade.name + " " + stade.commune + " " + stade.zipCode,
                                map : map,
                                animation: google.maps.Animation.DROP
                            });
                            marker.addListener("click", function () {
                                infoWindow.setContent(markerInfo(stade));
                                infoWindow.open(map, marker);
                            });
                            markers.push(marker);
                        });
                        var markerCluster = new MarkerClusterer(map, markers,
                                {imagePath: '/Ressources/images/clusters/m'});
                    }
                }, 'json'
        );
    }
    function markerInfo(stade) {
        return  '<div class="">'+
                '<h4>' + stade.name + ', ' + stade.commune + ' ' + stade.zipCode + '</h4>'+
                '<a href="" data-stadeId="' + stade.id + '" class="selectStade btn btn-success">jouer dans ce stade</a>'+
                '</div>';
    }
</script>